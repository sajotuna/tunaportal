<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.fourth.tuna.domain.lectureQna.mapper.LectureQnaMapper">

<resultMap type="HashMap" id="ClobToString">

	<result property="content" column="CONTENT" jdbcType="CLOB" javaType="java.lang.String" />

</resultMap>

	<resultMap 
		id="lectureQnaMapWithSubjectAndStudent"
		type="co.fourth.tuna.domain.lectureQna.vo.LectureQnaVO">
		<association 
			property="subjectVO"
			column="sbjno"
			javaType="co.fourth.tuna.domain.subject.vo.SubjectVO"			
			select="co.fourth.tuna.domain.subject.mapper.SubjectMapper.findOne"
		/>
		<association 
			property="studentVO" 
			column="stno"
			javaType="co.fourth.tuna.domain.user.vo.StudentVO"
			select="co.fourth.tuna.domain.user.mapper.StudentMapper.findOneById"
		/>
	
	</resultMap>
<!-- 질문목록 -->
	<select id="qnaList" resultType="map" parameterType="HashMap">
	<![CDATA[
	SELECT *
	FROM
    (SELECT Q.*, S.NAME,  ROWNUM RN
	FROM STUDENT S, LECTUREQNA Q, LECTUREAPPLY L
	WHERE Q.SBJNO = #{sbjNo}
    ORDER BY RN DESC)
    WHERE RN 
    	BETWEEN (#{pageNum}-1) * #{size} +1
    	AND #{pageNum}*#{size}
    ]]>
	</select>
	
	<!-- 질문단건조회 -->
	<select id="qnaSelect" resultType="map" parameterType="co.fourth.tuna.domain.lectureQna.vo.LectureQnaVO" resultMap="ClobToString">
	
	SELECT Q.*, S.NAME, L.SBJNO
	FROM STUDENT S, LECTUREQNA Q, LECTUREAPPLY L
	WHERE S.NO = #{stNo}
    AND S.NO = L.STNO
    AND L.SBJNO = Q.SBJNO
	AND Q.SBJNO = #{sbjNo}
	AND Q.NO = #{no}
	</select>
<!-- 
질문작성
<insert id="qnsInsert" parameterType="co.fourth.tuna.domain.lectureQna.vo.LectureQnaVO">
INSERT INTO LECTUREQNA
VALUES(?, ?, ?, ?, ?, ?, ?, ?)
</insert> -->

<!-- 목록 subject으로 찾기 -->
	<select id="findBySubjectId"
		resultType="co.fourth.tuna.domain.lectureQna.vo.LectureQnaVO">
		SELECT *
		FROM lectureqna
		WHERE sbjno = #{no}
	</select>
	
	<select id="findListWithSubjectAndStudentByProfessor"
		resultMap="lectureQnaMapWithSubjectAndStudent">
		SELECT *
		FROM (
			SELECT
			ROWNUM rn,
				l.*
			FROM lectureqna l
			JOIN subject s
				ON	l.sbjno = s.no
			WHERE s.pfno = #{prof.no}
		) WHERE rn 
				BETWEEN (#{pageNum}-1)*#{size}+1
				AND #{pageNum}*#{size}
	</select>

</mapper>
