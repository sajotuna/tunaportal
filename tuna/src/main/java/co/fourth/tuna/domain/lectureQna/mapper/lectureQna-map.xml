<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.fourth.tuna.domain.lectureQna.mapper.LectureQnaMapper">

<resultMap type="HashMap" id="ClobToString">

	<result property="content" column="CONTENT" jdbcType="CLOB" javaType="java.lang.String" />
	<result property="ANSWER" column="ANSWER" jdbcType="CLOB" javaType="java.lang.String" />

</resultMap>

	<resultMap 
		id="lectureQnaMapWithSubjectAndStudent"
		type="co.fourth.tuna.domain.lectureQna.vo.LectureQnaVO">
		<association 
			property="subjectVO"
			column="sbjno"
			javaType="co.fourth.tuna.domain.subject.vo.SubjectVO"			
			select="co.fourth.tuna.domain.subject.mapper.SubjectMapper.findOne"
		/>
		<association 
			property="studentVO" 
			column="stno"
			javaType="co.fourth.tuna.domain.user.vo.StudentVO"
			select="co.fourth.tuna.domain.user.mapper.StudentMapper.findOneById"
		/>
	
	</resultMap>
<!-- 질문목록 -->
	<select id="qnaList" resultType="map" parameterType="HashMap">
	<![CDATA[
	SELECT *
	FROM
    (SELECT
   		Q.NO, 
	    Q.TITLE, 
	    TO_CHAR(Q.CONTENT), 
	    Q.ANSWER, TO_CHAR(Q.ENROLLDATE, 'MM/DD HH24:MI') ENROLLDATE, 
	    Q.SBJNO,
	    TO_CHAR(Q.ANSWERDATE, 'MM/DD HH24:MI') ANSWERDATE, 
	    Q.VISIBLE,
	    S.NAME,  
  		ROWNUM RN
	FROM STUDENT S, LECTUREQNA Q, LECTUREAPPLY L
	WHERE Q.SBJNO = #{sbjNo}
    and s.no = l.stno
    and q.sbjno = l.sbjno
    ORDER BY RN DESC)
    WHERE RN 
    	BETWEEN (#{pageNum}-1) * #{size} +1
    	AND #{pageNum}*#{size}
    ]]>
	</select>
	
	<!-- 질문단건조회 -->
	<select id="qnaSelect" resultType="map" parameterType="co.fourth.tuna.domain.lectureQna.vo.LectureQnaVO" resultMap="ClobToString">
	
	SELECT Q.*, S.NAME, L.SBJNO
	FROM STUDENT S, LECTUREQNA Q, LECTUREAPPLY L
	WHERE S.NO = #{stNo}
    AND S.NO = L.STNO
    AND L.SBJNO = Q.SBJNO
	AND Q.SBJNO = #{sbjNo}
	AND Q.NO = #{no}
	</select>
 
<!-- 질문작성 -->
<insert id="insertOneQna" parameterType="co.fourth.tuna.domain.lectureQna.vo.LectureQnaVO">
<selectKey resultType="int" keyProperty="no" order="BEFORE">
SELECT CASE WHEN MAX(NO) != 0 THEN MAX(NO) + 1 ELSE 1 END FROM LECTUREQNA
</selectKey>
INSERT INTO LECTUREQNA
VALUES(#{no}, #{title}, #{content}, null, sysdate, #{stNo}, #{sbjNo}, null, #{visible})
</insert>

<!-- 목록 subject으로 찾기 -->
	<select id="findBySubjectId"
		resultType="co.fourth.tuna.domain.lectureQna.vo.LectureQnaVO">
		SELECT *
		FROM lectureqna
		WHERE sbjno = #{no}
	</select>
	
	<select id="findListWithSubjectAndStudentByProfessor"
		resultMap="lectureQnaMapWithSubjectAndStudent">
		SELECT *
		FROM (
			SELECT
			ROWNUM rn,
				l.*
			FROM lectureqna l
			JOIN subject s
				ON	l.sbjno = s.no
			WHERE s.pfno = #{prof.no}
		) WHERE rn 
				BETWEEN (#{pageNum}-1)*#{size}+1
				AND #{pageNum}*#{size}
	</select>
	
	<select id="findListBySubjectId"
		resultMap="lectureQnaMapWithSubjectAndStudent">
		SELECT *
		FROM lectureQna
		WHERE sbjno = ${sbjno}
	</select>
	
</mapper>
