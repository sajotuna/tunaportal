<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    data-layout-decorate="~{layouts/adminLayout}">
<head>
	<meta charset="UTF-8">
	<meta name="_csrf" th:content="${_csrf.token}">
  	<meta name="_csrf_header" th:content="${_csrf.headerName}">
	<title>sliderBannerManagm</title>
	<link rel="stylesheet" th:href="@{/resources/assets/js/plugins/slick-carousel/slick.css}">
	<link rel="stylesheet" th:href="@{/resources/assets/js/plugins/slick-carousel/slick-theme.css}">
	<link rel="stylesheet" th:href="@{/resources/assets/js/plugins/sweetalert2/sweetalert2.min.css}">
	<link rel="stylesheet" th:href="@{/resources/assets/css/bn-preview.css}">
	<style>
	
	</style>
</head>
<body>
<main layout:fragment="main">
	<!-- Page Content -->
	<div class="mt-3">
	<div class="content">
		<p class="h3 fw-bold">슬라이드 배너 등록 및 삭제</p>
		<div class="block block-rounded">
			<div class="block-content block-content-full">
				<div class="m-3">
				<div class="row justify-content-center">
				<div class="col-xl-10">
				<!-- Image Preview -->
				<h2 class="content-heading mb-2 pb-2">사진 미리보기</h2>
				<div class="mb-5 d-flex justify-content-center preview">
					<div class="img-section">
						<img id="previewImg" class="img" th:src="@{/display?fileName=no_image.png&folder=banner}" alt="preview image">
					</div> 
				</div>
				<!-- END Image Preview -->
				<!-- Image List -->
				<div class="block block-rounded block-themed mb-4">
					<div class="block-header bg-primary-darker">
						<h4 class="block-title">배너 사진 목록</h4>
						<div class="block-options">
						<button type="button" class="btn btn-sm btn-light submit-btn" data-job="delete" style="margin-right: 10px;">삭제</button>
						<label class="upload-label" for="file">
							<button id="upload" class="btn btn-sm btn-light upload-btn">사진 올리기</button>
						</label>
						<input class="form-control hidden-file" type="file" id="file" name="file"
							   accept="image/jpg, image/jpeg, image/png">
						</div>
					</div>
					<table class="table table-hover table-vcenter">
						<thead>
							<tr>
								<th width=30></th>
								<th>파일명</th>
								<th width=30>
									<button class="btn btn-sm up" type="button">
										<i class="fa fa-arrow-up"></i>
									</button>
								</th>
								<th width=30>
									<button class="btn btn-sm down" type="button">
										<i class="fa fa-arrow-down"></i>
									</button>
								</th>
							</tr>
						</thead>
						<tbody id="tb">
							<th:block th:each="bn, i:${bnList}">
								<input type="hidden" th:data-adNo="139341" >
								<tr th:data-no="${bn.no}" 
									th:data-uri="${bn.uri}" th:data-filename="${bn.fileName}" style="cursor:pointer;">
									<td scope="row" class="fw-semibold fs-sm">
										<input class="form-check-input" type="radio" name="check">
									</td>
									<td class="fw-semibold fs-sm fileName" colspan="3">[[${bn.fileName}]]</td>
								</tr>
							</th:block>
						</tbody>
					</table>
					<div class="d-flex justify-content-center mt-5">
						<button type="button"id="sliderPreview" class="btn btn-sm btn-light me-2"
							data-bs-toggle="modal" data-bs-target="#modal-block-vcenter">배너 미리보기</button>
						<button type="button" class="btn btn-sm btn-dark submit-btn" data-job="submit" data-bs-dismiss="modal">순서 등록</button>
            		</div>
				</div>
				<!-- END Image List -->
				</div>
				</div>
				</div>
			</div>
		</div>
	</div>
	</div>
	<!-- END Page Content -->
	
	<!-- Banner Preview Modal -->
	<div class="modal" id="modal-block-vcenter" tabindex="-1" role="dialog" aria-labelledby="modal-block-vcenter" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="block block-rounded block-transparent mb-0">
					<div class="block-header block-header-default">
						<h3 class="block-title">슬라이드 배너 미리보기</h3>
						<div class="block-options">
							<button type="button" class="btn-block-option" data-bs-dismiss="modal" aria-label="Close">
								<i class="fa fa-fw fa-times"></i>
							</button>
						</div>
					</div>
					<div class="block-content block-content-full text-end bg-body">
						<div class="js-slider slick-dotted-inner slick-dotted-white"
							data-dots="true" data-autoplay="true" data-autoplay-speed="1000">
							<th:div th:each="bn, i:${bnList}" class="img-section">
								<img class="img-fluid img" alt="">
							</th:div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- END Banner Preview Modal -->
	<script th:src="@{/resources/assets/js/plugins/slick-carousel/slick.min.js}"></script>
	<script th:src="@{/resources/assets/js/plugins/sweetalert2/sweetalert2.min.js}"></script>
	<script>One.helpersOnLoad([ 'jq-slick' ]);</script>
	<script type="text/javascript">
	
		var header = $("meta[name='_csrf_header']").attr('content');
		var token = $("meta[name='_csrf']").attr('content');
		
		$(function() {
			preview();
			sliderPreview();
			submit();
		})
		
		function sliderPreview() {
			
			$('#sliderPreview').on('click', function() {
				
				$('#tb tr').each(function(idx) {
					let uri = $('#tb tr').eq(idx).data('uri');
					$('.img-fluid').eq(idx+1).attr('src', 
											getContextPath() 
											+ `display?fileName=${uri}&folder=banner`);
				})
				
			})	
			
		}
		
		// 사진 업로드
		$('#file').on('change', changeEvent => {
			
			let formData = new FormData();
			formData.append('file', $('input[name=file]').prop('files')[0]);
			formData.append('adNo', $('#adNo').val());
			
			$.ajax({
			
				url: getContextPath() + 'admin/sliderBanner',
				method:'POST',
				data: formData,
				contentType: false,
				processData: false,
				beforeSend: function (xhr) {
			       xhr.setRequestHeader(header, token);
				}
			}).done(function(success) {
				pageDialogs.dialog('upload');
			})
				
				
		})
		
		// 클릭 시 1건 미리보기
		function preview() {
			$('#tb tr').on('click', function() {
				$('#tb tr').removeClass('table-primary');
				$(this).closest('tr').addClass('table-primary')
									 .find('input[type=radio]').prop("checked", true);
				$('#previewImg').attr('src', 
								getContextPath() 
								+ `display?fileName=${$(this).data('uri')}&folder=banner`);
				
			})
		}
	
		// 순서 등록 완료 / 삭제 버튼 클릭
		function submit() {
			$('.submit-btn').on('click', function () {
				let job = $(this).data('job');
			
				if (job === 'submit') {
					$('#tb tr').each(function(idx) {
						$.ajax({
							
							url: getContextPath() + 'admin/sliderBanner',
							method:'PUT',
							data: JSON.stringify({sequence:idx+1, no:$(this).data('no')}),
							contentType : 'application/json; charset=utf-8',
							beforeSend: function (xhr) {
						       xhr.setRequestHeader(header, token);
							}
						})
					})
					pageDialogs.dialog(job);
					
				} else if (job === 'delete') {
					pageDialogs.dialog(job);
				}
			})
		}
		
		// dialog
		class pageDialogs {
			static dialog(job, txt) {
			    let toast = Swal.mixin({
			      buttonsStyling: false,
			      target: '#page-container',
			      customClass: {
			        confirmButton: 'btn btn-dark m-1',
			        cancelButton: 'btn btn-danger m-1',
			        input: 'form-control'
			      }
			    });
			    
			    success();
			    
			    function success(e) {
			    	
			    	if(job === 'upload') {
			    		
			    		toast.fire({
			    			title:'업로드 완료', 
			    			text:'이제 사진 순서를 변경한 후 미리보기에서 등록할 수 있습니다.', 
			    			icon: 'success',
			    			confirmButtonText: '확인'
			    		}).then(result => {
			    			if (result.value) {
			  	            	location.reload();
			  	          	}
			    		});
			    		
			    	} else if (job === 'submit') {
			    		
			    		toast.fire({
			    			
			  	          title: '등록 완료',
			  	          text: '메인 페이지로 돌아가 배너를 확인해 보세요.',
			  	          icon: 'success',
			  	          showCancelButton: true,
			  	          customClass: {
			  	            confirmButton: 'btn btn-dark m-1',
			  	            cancelButton: 'btn btn-light m-1'
			  	          },
			  	          confirmButtonText: '메인으로 가기',
			  	          cancelButtonText: '취소',
			  	          preConfirm: e => {
			  	            return new Promise(resolve => {
			  	              setTimeout(() => {
			  	                resolve();
			  	              }, 50);
			  	            });
			  	          }
			  	          
			  	        }).then(result => {
			  	          if (result.value) {
			  	            location.href = '/tuna/admin';
			  	          } else if (result.dismiss === 'cancel') {
			  	            location.reload();
			  	          }
			  	        });
			    		
			    	} else if (job === 'delete') {
			    		
			    		toast.fire({
			    			
			  	          title: '정말로 삭제하시겠습니까?',
			  	          text: '이 작업은 취소할 수 없습니다.',
			  	          icon: 'warning',
			  	          showCancelButton: true,
			  	          customClass: {
			  	            confirmButton: 'btn btn-danger m-1',
			  	            cancelButton: 'btn btn-light m-1'
			  	          },
			  	          confirmButtonText: '삭제하기',
			  	          cancelButtonText: '취소',
			  	          preConfirm: e => {
			  	            return new Promise(resolve => {
			  	              setTimeout(() => {
			  	                resolve();
			  	              }, 50);
			  	            });
			  	          }
					  	          
			  	       }).then(result => {
				  	        if (result.value) {
					  	  		let tr = $('#tb input:radio:checked').closest('tr');
								
								$.ajax({
									
									url: getContextPath() + 'admin/banner',
									method:'DELETE',
									data: JSON.stringify({uri:tr.data('uri'),no:tr.data('no')}),
									contentType : 'application/json; charset=utf-8',
									beforeSend: function (xhr) {
								       xhr.setRequestHeader(header, token);
									}
							
								}).done(function(success) {
									if(success) {
										pageDialogs.dialog('success');
									}
								})
				  	        }
			  	        });
			    	} else if (job === 'success') {
			    		
			    		toast.fire({
			    			
				  	          title: '삭제 완료',
				  	          text: '삭제가 정상적으로 처리되었습니다.',
				  	          icon: 'success',
				  	          showCancelButton: false,
				  	          customClass: {
				  	            confirmButton: 'btn btn-dark m-1',
				  	          },
				  	          confirmButtonText: '확인',
				  	          preConfirm: e => {
				  	            return new Promise(resolve => {
				  	              setTimeout(() => {
				  	                resolve();
				  	              }, 50);
				  	            });
				  	          }
						  	          
				  	       }).then(result => {
					  	        location.reload();
				  	        });
			    		
			    	}
			  	}
			}
		}
	
		
		
		// 위로 이동
		$('.up').on('click', function() {
			let tr = $('#tb input:radio:checked').closest('tr');
			let prevTr = tr.prev();
			tr.insertBefore(prevTr);
		})
		
		// 아래로 이동
		$('.down').on('click', function() {
			let tr = $('#tb input:radio:checked').closest('tr');
			let nextTr = tr.next();
			tr.insertAfter(nextTr);
		})
	
	function getContextPath() {
		var pathName = window.location.pathname.substring(1);
		var webName = pathName == '' ? '' : pathName.substring(0, pathName.indexOf('/'));
		var path_root = window.location.protocol + '//' + window.location.host + '/' + webName + '/';
		return path_root;
	}
	</script>
	
</main>
</body>
</html>